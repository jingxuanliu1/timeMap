{% extends 'base.html' %}

{% block content %}
<div class="container py-4" style="max-width: 700px; margin: auto;">
  <!-- Display the selected date -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <div class="d-flex flex-column">
        <button onclick="window.location='{% url 'tasks:index' %}?selected_date={% now 'Y-m-d' %}&start_date={% now 'Y-m-d' %}'"
                class="btn btn-link p-0 border-0 text-decoration-none align-self-start">
          <h2 class="fw-bold mb-0" style="font-size: 2.2em;">Today</h2>
        </button>
        <span class="text-muted" style="font-size: 1.2em;">{{ display_date }}</span>
      </div>
    </div>
    <button id="calendar-btn" class="btn rounded-circle" title="Select Date">
      <i class="fas fa-calendar-alt"></i>
    </button>
  </div>

  <!-- Hidden form for calendar date selection -->
  <form id="date-form" method="GET" action="{% url 'tasks:index' %}" style="display: none;">
    <input type="date" name="selected_date" id="date-input" value="{{ selected_date }}">
    <input type="hidden" name="start_date" value="{{ start_date }}">
  </form>

  <!-- Calendar/Date Bar with dynamic dates -->
  <div class="d-flex justify-content-between gap-2 mb-4" id="date-bar">
    {% for day in days %}
      <div class="text-center flex-fill px-2 py-2 rounded {% if day.date_str == selected_date %}bg-primary text-white{% else %}bg-light{% endif %}"
           style="cursor: pointer;">
        {{ day.day_name }}<br><strong data-date="{{ day.date_str }}">{{ day.day_number }}</strong>
      </div>
    {% endfor %}
  </div>

  <!-- Task List with Scrollable Container -->
  <div class="task-list-container" style="max-height: 50vh; overflow-y: auto; margin-bottom: 60px;">
    {% for task in tasks %}
      <div class="card shadow-sm mb-3 bg-task">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1 text-white">{{ task.title }}</h5>
            {% if task.start_time and task.end_time %}
              <small class="text-light">
                {{ task.start_time|date:"g:i A" }} - {{ task.end_time|date:"g:i A" }}
              </small>
            {% elif task.start_time %}
              <small class="text-light">{{ task.start_time|date:"g:i A" }}</small>
            {% endif %}
            {% if task.location %}
              <br><small class="text-light">{{ task.location }}</small>
            {% endif %}
          </div>
          <div>
            <a href="{% url 'tasks:update_task' task.id %}?selected_date={{ selected_date }}&start_date={{ start_date }}"
               class="btn btn-sm btn-outline-light me-2" title="Modify">
              <i class="fas fa-pencil-alt"></i>
            </a>
            <a href="{% url 'tasks:delete_task' task.id %}?selected_date={{ selected_date }}&start_date={{ start_date }}"
               class="btn btn-sm btn-outline-light" onclick="return confirm('Are you sure you want to delete this task?');">âœ–</a>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No tasks for today.</p>
    {% endfor %}
  </div>

  <!-- Add Task Button (Positioned Above Footer) -->
  <div class="add-task-footer">
    <a href="{% url 'tasks:create_task' %}?selected_date={{ selected_date }}&start_date={{ start_date }}"
       class="btn btn-primary btn-lg d-flex align-items-center justify-content-center add-task-btn">
      <span class="me-2">+</span> Add Task
    </a>
  </div>
</div>

<!-- JavaScript for Calendar Interaction -->
<script>
  document.getElementById('calendar-btn').addEventListener('click', function() {
    document.getElementById('date-input').showPicker();
  });

  document.getElementById('date-input').addEventListener('change', function() {
    const form = document.getElementById('date-form');
    form.elements['selected_date'].value = this.value;
    form.elements['start_date'].value = this.value; // Reset start_date to selected_date
    form.submit();
  });

  document.querySelectorAll('#date-bar > div').forEach(box => {
    box.addEventListener('click', function() {
      const dateStr = this.querySelector('strong').getAttribute('data-date');
      const form = document.getElementById('date-form');
      form.elements['selected_date'].value = dateStr;
      form.elements['start_date'].value = "{{ start_date }}"; // Preserve start_date
      form.submit();
    });
  });
</script>
{% endblock %}